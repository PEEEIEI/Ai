<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ciel - Intelligent Multi-Agent Engine</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;700&family=Nunito:wght@400;600;700&family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS with Custom Configuration -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        background: ({ opacityValue }) => `rgba(var(--bg-rgb), ${opacityValue || 1})`,
                        surface: ({ opacityValue }) => `rgba(var(--surface-rgb), ${opacityValue || 1})`,
                        surface2: ({ opacityValue }) => `rgba(var(--surface2-rgb), ${opacityValue || 1})`,
                        border: ({ opacityValue }) => `rgba(var(--border-rgb), ${opacityValue || 1})`,
                        
                        txt: {
                            main: ({ opacityValue }) => `rgba(var(--text-main-rgb), ${opacityValue || 1})`,
                            sec: ({ opacityValue }) => `rgba(var(--text-sec-rgb), ${opacityValue || 1})`,
                            muted: ({ opacityValue }) => `rgba(var(--text-muted-rgb), ${opacityValue || 1})`,
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Markdown & Sanitize -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            /* Default (Dark) - Slate based */
            --bg-rgb: 15, 23, 42;        /* slate-900 */
            --surface-rgb: 30, 41, 59;   /* slate-800 */
            --surface2-rgb: 51, 65, 85;  /* slate-700 */
            --border-rgb: 51, 65, 85;    /* slate-700 */
            --text-main-rgb: 226, 232, 240; /* slate-200 */
            --text-sec-rgb: 203, 213, 225;  /* slate-300 */
            --text-muted-rgb: 148, 163, 184; /* slate-400 */
        }

        [data-theme="light"] {
            /* Light Theme - White/Gray based */
            --bg-rgb: 248, 250, 252;     /* slate-50 */
            --surface-rgb: 255, 255, 255; /* white */
            --surface2-rgb: 226, 232, 240; /* slate-200 */
            --border-rgb: 203, 213, 225;   /* slate-300 */
            --text-main-rgb: 15, 23, 42;   /* slate-900 */
            --text-sec-rgb: 51, 65, 85;    /* slate-700 */
            --text-muted-rgb: 100, 116, 139; /* slate-500 */
        }

        [data-theme="midnight"] {
            /* Midnight Theme - Pure Black/Zinc */
            --bg-rgb: 0, 0, 0;            /* black */
            --surface-rgb: 24, 24, 27;    /* zinc-900 */
            --surface2-rgb: 39, 39, 42;   /* zinc-800 */
            --border-rgb: 63, 63, 70;     /* zinc-700 */
            --text-main-rgb: 244, 244, 245; /* zinc-100 */
            --text-sec-rgb: 212, 212, 216;  /* zinc-300 */
            --text-muted-rgb: 113, 113, 122; /* zinc-500 */
        }

        /* Base Styles */
        body {
            font-family: 'Nunito', 'Sarabun', sans-serif;
            background-color: rgb(var(--bg-rgb));
            color: rgb(var(--text-main-rgb));
            overflow-x: hidden;
            overscroll-behavior-y: none; 
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        h1, h2, h3, .brand-font {
            font-family: 'Fredoka', 'Sarabun', sans-serif;
        }
        
        /* Background Blobs Animation */
        .blob {
            position: absolute;
            filter: blur(60px);
            z-index: -1;
            opacity: 0.5;
            will-change: transform;
            animation: float 10s infinite ease-in-out;
        }
        
        /* Cool Sci-Fi Loader */
        #page-loader {
            position: fixed;
            inset: 0;
            background-color: rgb(var(--bg-rgb));
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 2rem;
            transition: opacity 0.6s ease-out, visibility 0.6s;
        }

        .loader-visual {
            position: relative;
            width: 100px;
            height: 100px;
        }

        .loader-circle {
            position: absolute;
            border: 4px solid transparent;
            border-radius: 50%;
        }

        /* Outer Ring */
        .loader-circle.one {
            top: 0; left: 0; right: 0; bottom: 0;
            border-top-color: #ec4899; /* Pink-500 */
            border-bottom-color: rgba(236, 72, 153, 0.1);
            animation: spin 1.5s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            filter: drop-shadow(0 0 10px rgba(236, 72, 153, 0.5));
        }

        /* Middle Ring */
        .loader-circle.two {
            top: 12px; left: 12px; right: 12px; bottom: 12px;
            border-top-color: #8b5cf6; /* Violet-500 */
            border-right-color: rgba(139, 92, 246, 0.1);
            animation: spin 2s cubic-bezier(0.5, 0, 0.5, 1) infinite reverse;
            filter: drop-shadow(0 0 10px rgba(139, 92, 246, 0.5));
        }

        /* Inner Ring */
        .loader-circle.three {
            top: 24px; left: 24px; right: 24px; bottom: 24px;
            border-top-color: #3b82f6; /* Blue-500 */
            animation: spin 2.5s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.5));
        }

        .loader-text {
            font-family: 'Fredoka', sans-serif;
            font-size: 1rem;
            letter-spacing: 0.4em;
            text-transform: uppercase;
            background: linear-gradient(to right, #ec4899, #8b5cf6, #3b82f6);
            -webkit-background-clip: text;
            color: transparent;
            animation: pulse-glow 2s infinite;
            font-weight: 700;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse-glow {
            0%, 100% { opacity: 0.6; filter: drop-shadow(0 0 0px transparent); }
            50% { opacity: 1; filter: drop-shadow(0 0 15px rgba(139, 92, 246, 0.6)); }
        }
        
        /* Text Glow Animation */
        .text-glow-anim {
            animation: text-flicker 3s infinite alternate;
        }
        @keyframes text-flicker {
            0%, 100% { filter: drop-shadow(0 0 10px rgba(236, 72, 153, 0.3)); }
            50% { filter: drop-shadow(0 0 25px rgba(139, 92, 246, 0.6)); }
        }

        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(20px, -20px) scale(1.1); }
            100% { transform: translate(0, 0) scale(1); }
        }
        
        /* Chat Scrollbar */
        .chat-container {
            scrollbar-width: thin;
            scrollbar-color: rgba(var(--text-muted-rgb), 0.5) rgba(var(--surface-rgb), 0.5);
            scroll-behavior: smooth;
        }
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: rgba(var(--surface-rgb), 0.5);
        }
        .chat-container::-webkit-scrollbar-thumb {
            background-color: rgba(var(--text-muted-rgb), 0.5);
            border-radius: 20px;
        }
        
        /* Chips Scroll */
        .chips-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .chips-container::-webkit-scrollbar {
            display: none;
        }

        /* Typing Indicator */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* Markdown Styles */
        .prose p { margin-bottom: 0.5rem; }
        .prose ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 0.5rem; }
        .prose ol { list-style-type: decimal; margin-left: 1.5rem; margin-bottom: 0.5rem; }
        .prose code { background: rgba(var(--surface2-rgb), 0.5); padding: 2px 6px; border-radius: 4px; font-family: monospace; color: rgb(var(--text-main-rgb)); font-size: 0.9em; }
        
        .prose pre { 
            background: rgba(var(--bg-rgb), 0.8); 
            padding: 1rem; 
            border-radius: 0.5rem; 
            overflow-x: auto; 
            margin-bottom: 0.5rem; 
            border: 1px solid rgba(var(--border-rgb), 0.5); 
            position: relative; 
        }
        
        .prose pre code { 
            background: transparent; 
            padding: 0; 
            color: #a5b4fc; 
        }
        
        /* Light mode specific adjustment for code */
        [data-theme="light"] .prose pre code { color: #6366f1; }
        
        .prose strong { color: #f472b6; font-weight: bold; }
        .prose h1, .prose h2, .prose h3 { color: rgb(var(--text-main-rgb)); font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; }
        .prose a { color: #38bdf8; text-decoration: underline; }
        .prose blockquote { border-left: 4px solid rgba(var(--text-muted-rgb), 0.5); padding-left: 1rem; color: rgb(var(--text-muted-rgb)); font-style: italic; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(var(--bg-rgb), 0.9);
            backdrop-filter: blur(5px);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }
        
        /* Nav & Views */
        .nav-link.active {
            color: rgb(var(--text-main-rgb));
            background-color: rgba(var(--surface2-rgb), 0.5);
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.3);
        }
        .nav-btn-active {
            background: linear-gradient(to right, #db2777, #7c3aed) !important;
            color: white !important;
            box-shadow: 0 10px 15px -3px rgba(219, 39, 119, 0.3) !important;
        }
        
        .view-section {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            width: 100%;
        }
        .view-section.active {
            display: flex;
            opacity: 1;
        }
        
        #mobile-menu { z-index: 50; }
        .hidden-menu { display: none; }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            .mobile-full-screen {
                height: 100vh !important;
                height: 100dvh !important;
                border-radius: 0 !important;
                border: none !important;
                width: 100%;
                z-index: 40;
                background-color: rgb(var(--bg-rgb));
            }
            .mobile-hide { display: none !important; }
            main { padding: 0 !important; }
            body.in-chat nav { display: none; }
            body.in-chat main { height: 100vh; overflow: hidden; }
        }

        /* Tabs Styles */
        .tab-btn {
            @apply px-4 py-2 md:px-6 md:py-2 rounded-full text-txt-muted font-medium transition-all duration-300 border border-transparent whitespace-nowrap;
        }
        .tab-btn.active {
            @apply bg-surface text-txt-main border-border shadow-lg shadow-pink-500/10;
        }

        /* Session Item Styles */
        .session-item {
            @apply flex items-center justify-between p-3 rounded-xl cursor-pointer transition-all duration-200 border border-transparent;
        }
        .session-item:hover {
            @apply bg-surface2/50;
        }
        .session-item.active-session {
            @apply bg-surface2 border-pink-500/30 text-txt-main shadow-md;
        }
        .session-item .delete-btn {
            @apply opacity-0 transition-opacity duration-200 p-1.5 rounded-lg hover:bg-red-500/20 hover:text-red-400 text-txt-muted;
        }
        .session-item:hover .delete-btn {
            @apply opacity-100;
        }
    </style>
</head> 
<body class="min-h-screen flex flex-col relative overflow-x-hidden">

    <!-- Loader -->
    <div id="page-loader">
        <div class="loader-visual">
            <div class="loader-circle one"></div>
            <div class="loader-circle two"></div>
            <div class="loader-circle three"></div>
        </div>
        <p class="loader-text">INITIALIZING...</p>
    </div>

    <!-- Background Blobs -->
    <div class="blob bg-purple-600 w-96 h-96 rounded-full top-0 left-0 -translate-x-1/2 -translate-y-1/2"></div>
    <div class="blob bg-blue-600 w-80 h-80 rounded-full bottom-0 right-0 translate-x-1/3 translate-y-1/3"></div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal">
        <div class="bg-surface p-8 rounded-3xl border border-border w-full max-w-md shadow-2xl m-4 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-pink-500/20 blur-3xl rounded-full pointer-events-none"></div>
            <div class="absolute bottom-0 left-0 w-32 h-32 bg-blue-500/20 blur-3xl rounded-full pointer-events-none"></div>

            <div id="login-form" class="relative z-10">
                <h3 class="text-2xl font-bold mb-2 text-txt-main text-center" data-i18n="login_title">Welcome Back</h3>
                <p class="text-txt-muted text-center mb-6 text-sm" data-i18n="login_subtitle">Enter your details to sign in</p>
                
                <form onsubmit="handleLogin(event)" class="space-y-4 mt-6">
                    <input type="email" id="login-email" required class="w-full bg-background/50 border border-border rounded-xl p-3 text-txt-main focus:ring-2 focus:ring-pink-500 outline-none transition" placeholder="name@example.com">
                    <input type="password" id="login-password" required class="w-full bg-background/50 border border-border rounded-xl p-3 text-txt-main focus:ring-2 focus:ring-pink-500 outline-none transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    <button type="submit" class="w-full py-3 bg-gradient-to-r from-pink-600 to-violet-600 hover:from-pink-500 hover:to-violet-500 text-white rounded-xl font-bold shadow-lg shadow-pink-500/25 transition transform hover:scale-[1.02]">
                        <span data-i18n="btn_login">Sign In</span>
                    </button>
                </form>
                
                <p class="text-center mt-6 text-txt-muted text-sm">
                    Don't have an account? <button onclick="toggleAuthMode('signup')" class="text-pink-400 hover:text-pink-300 font-bold ml-1">Sign Up</button>
                </p>
            </div>

            <div id="signup-form" class="hidden relative z-10">
                <h3 class="text-2xl font-bold mb-2 text-txt-main text-center" data-i18n="signup_title">Create Account</h3>
                <p class="text-txt-muted text-center mb-6 text-sm" data-i18n="signup_subtitle">Join us and start creating</p>
                
                <form onsubmit="handleSignup(event)" class="space-y-4">
                    <div>
                        <label class="block text-txt-muted text-xs mb-1 ml-1">Full Name</label>
                        <input type="text" id="signup-name" required class="w-full bg-background/50 border border-border rounded-xl p-3 text-txt-main focus:ring-2 focus:ring-pink-500 outline-none transition" placeholder="John Doe">
                    </div>
                    <div>
                        <label class="block text-txt-muted text-xs mb-1 ml-1">Email</label>
                        <input type="email" id="signup-email" required class="w-full bg-background/50 border border-border rounded-xl p-3 text-txt-main focus:ring-2 focus:ring-pink-500 outline-none transition" placeholder="name@example.com">
                    </div>
                    <div>
                        <label class="block text-txt-muted text-xs mb-1 ml-1">Password</label>
                        <input type="password" id="signup-password" required class="w-full bg-background/50 border border-border rounded-xl p-3 text-txt-main focus:ring-2 focus:ring-pink-500 outline-none transition" placeholder="Create a password">
                    </div>
                    <button type="submit" class="w-full py-3 bg-gradient-to-r from-pink-600 to-violet-600 hover:from-pink-500 hover:to-violet-500 text-white rounded-xl font-bold shadow-lg shadow-pink-500/25 transition transform hover:scale-[1.02]">
                        <span data-i18n="btn_signup">Create Account</span>
                    </button>
                </form>
                
                <p class="text-center mt-6 text-txt-muted text-sm">
                    Already have an account? <button onclick="toggleAuthMode('login')" class="text-pink-400 hover:text-pink-300 font-bold ml-1">Log In</button>
                </p>
            </div>

            <button onclick="closeAuthModal()" class="absolute top-4 right-4 text-txt-muted hover:text-txt-main transition">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal">
        <div class="bg-surface p-6 rounded-2xl border border-border w-full max-w-sm shadow-2xl m-4 text-center relative z-50">
            <div class="w-16 h-16 bg-surface2/50 rounded-full flex items-center justify-center mx-auto mb-4 text-orange-400">
                <i data-lucide="alert-triangle" class="w-8 h-8"></i>
            </div>
            <h3 class="text-xl font-bold mb-2 text-txt-main" id="confirm-title">Are you sure?</h3>
            <p class="text-txt-muted text-sm mb-6" id="confirm-message">This action cannot be undone.</p>
            
            <div class="flex gap-3 justify-center">
                <button onclick="closeConfirmModal()" class="px-5 py-2 rounded-xl bg-surface2 hover:bg-border text-txt-main transition font-medium">
                    Cancel
                </button>
                <button id="confirm-yes-btn" class="px-5 py-2 rounded-xl bg-red-600 hover:bg-red-700 text-white transition font-medium shadow-lg shadow-red-600/20">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="handleAvatarUpload(event)">

    <!-- Navbar -->
    <nav id="main-nav" class="w-full p-4 md:p-6 flex flex-col z-20 sticky top-0 backdrop-blur-sm bg-background/10 transition-all">
        <div class="flex justify-between items-center w-full">
            <div onclick="navigateTo('home')" class="cursor-pointer text-xl md:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-violet-500 brand-font py-1 leading-relaxed" data-i18n="brand_nav">
                Ciel
            </div>

            <div class="hidden md:flex items-center gap-1 bg-surface/40 p-1.5 rounded-full border border-border/50 backdrop-blur-md shadow-xl ring-1 ring-white/10">
                <button onclick="navigateTo('home')" id="nav-home" class="nav-link px-6 py-2 rounded-full text-txt-sec font-medium hover:text-txt-main hover:bg-white/10 transition-all duration-300 active" data-i18n="home">Home</button>
                <button onclick="navigateTo('chat')" id="nav-chat" class="nav-link px-6 py-2 rounded-full text-txt-sec font-medium hover:text-txt-main hover:bg-white/10 transition-all duration-300" data-i18n="ai_friend">Ciel</button>
            </div>

            <div class="flex items-center gap-2 md:gap-3">
                <!-- Theme Switcher -->
                <button onclick="toggleTheme()" class="flex items-center justify-center bg-surface/80 hover:bg-surface2 text-txt-sec px-3 py-1.5 md:px-3 md:py-2 rounded-full transition border border-border shadow-lg hover:shadow-xl" title="Change Theme">
                    <i data-lucide="palette" class="w-5 h-5"></i>
                </button>

                <button onclick="toggleLanguage()" class="flex items-center gap-2 bg-surface/80 hover:bg-surface2 text-txt-sec px-3 py-1.5 md:px-4 md:py-2 rounded-full transition border border-border shadow-lg hover:shadow-xl">
                    <span class="text-lg">üåê</span>
                    <span id="lang-label" class="text-sm font-bold">TH</span>
                </button>
                
                <div id="auth-buttons-desktop" class="hidden md:block">
                    <button onclick="openAuthModal()" class="bg-surface hover:bg-surface2 text-txt-main px-4 py-2 rounded-full font-bold border border-border transition flex items-center gap-2 shadow-lg">
                        <i data-lucide="user" class="w-4 h-4"></i> <span id="auth-btn-text">Login</span>
                    </button>
                </div>

                <div id="user-profile-menu" class="hidden relative">
                    <button onclick="toggleProfileMenu()" class="flex items-center gap-2 bg-surface/80 hover:bg-surface2 pr-4 pl-1 py-1 rounded-full border border-border transition">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-pink-500 to-violet-500 flex items-center justify-center text-white font-bold text-sm overflow-hidden" id="nav-user-avatar">U</div>
                        <span class="text-sm font-bold text-txt-main max-w-[100px] truncate" id="nav-user-name">User</span>
                    </button>
                    <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-surface border border-border rounded-xl shadow-xl overflow-hidden z-50">
                        <div class="p-3 border-b border-border">
                            <p class="text-xs text-txt-muted">Signed in as</p>
                            <p class="text-sm font-bold text-txt-main truncate" id="dropdown-email">user@example.com</p>
                        </div>
                        <button onclick="triggerClearChat()" class="w-full text-left px-4 py-3 text-txt-sec hover:bg-surface2/50 hover:text-txt-main text-sm transition flex items-center gap-2 border-b border-border">
                            <i data-lucide="message-square-off" class="w-4 h-4 text-orange-400"></i> Clear Chat
                        </button>
                        <button onclick="logout()" class="w-full text-left px-4 py-3 text-txt-sec hover:bg-surface2/50 hover:text-txt-main text-sm transition flex items-center gap-2 border-b border-border">
                            <i data-lucide="log-out" class="w-4 h-4"></i> Sign Out
                        </button>
                        <button onclick="triggerDeleteAccount()" class="w-full text-left px-4 py-3 text-red-400 hover:bg-red-500/10 hover:text-red-300 text-sm transition flex items-center gap-2">
                            <i data-lucide="trash-2" class="w-4 h-4"></i> Delete Account
                        </button>
                    </div>
                </div>
                
                <button onclick="toggleMobileMenu()" class="md:hidden p-2 text-txt-sec hover:text-txt-main bg-surface/80 rounded-full border border-border">
                    <i data-lucide="menu" id="mobile-menu-icon" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <div id="mobile-menu" class="hidden-menu w-full mt-4 bg-surface/90 backdrop-blur-xl border border-border/50 rounded-2xl overflow-hidden shadow-2xl">
            <div class="flex flex-col p-2 space-y-1">
                <button onclick="navigateTo('home'); toggleMobileMenu()" class="text-left px-4 py-3 rounded-xl hover:bg-background/10 text-txt-main font-medium transition flex items-center gap-3">
                    <i data-lucide="home" class="w-5 h-5 text-pink-400"></i> <span data-i18n="home">Home</span>
                </button>
                <button onclick="navigateTo('chat'); toggleMobileMenu()" class="text-left px-4 py-3 rounded-xl hover:bg-background/10 text-txt-main font-medium transition flex items-center gap-3">
                    <i data-lucide="message-circle" class="w-5 h-5 text-violet-400"></i> <span data-i18n="ai_friend">Ciel</span>
                </button>
                
                <div class="border-t border-border/50 my-2"></div>
                
                <div id="auth-buttons-mobile">
                    <button onclick="openAuthModal(); toggleMobileMenu()" class="w-full text-left px-4 py-3 rounded-xl hover:bg-background/10 text-txt-main font-medium transition flex items-center gap-3">
                        <i data-lucide="user" class="w-5 h-5 text-green-400"></i> Login / Sign Up
                    </button>
                </div>
                <div id="auth-actions-mobile" class="hidden">
                    <div class="px-4 py-2 text-xs text-txt-muted uppercase tracking-widest flex items-center gap-2">
                        <span id="mobile-user-name">User</span>'s Account
                    </div>
                    <button onclick="triggerClearChat(); toggleMobileMenu()" class="w-full text-left px-4 py-3 rounded-xl hover:bg-background/10 text-txt-sec font-medium transition flex items-center gap-3">
                        <i data-lucide="message-square-off" class="w-5 h-5 text-orange-400"></i> Clear Chat
                    </button>
                    <button onclick="logout(); toggleMobileMenu()" class="w-full text-left px-4 py-3 rounded-xl hover:bg-background/10 text-txt-sec font-medium transition flex items-center gap-3">
                        <i data-lucide="log-out" class="w-5 h-5"></i> Sign Out
                    </button>
                    <button onclick="triggerDeleteAccount(); toggleMobileMenu()" class="w-full text-left px-4 py-3 rounded-xl hover:bg-red-500/10 text-red-400 font-medium transition flex items-center gap-3">
                        <i data-lucide="trash-2" class="w-5 h-5"></i> Delete Account
                    </button>
                </div>

                <div class="border-t border-border/50 my-2"></div>
                <div class="px-4 py-2 text-xs text-txt-muted uppercase tracking-widest">
                    Quick Actions
                </div>
                <button onclick="document.getElementById('avatar-upload').click(); toggleMobileMenu()" class="text-left px-4 py-3 rounded-xl hover:bg-background/10 text-txt-sec font-medium transition flex items-center gap-3 text-sm">
                    <i data-lucide="camera" class="w-4 h-4"></i> Change Avatar
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-container" class="flex-grow container mx-auto px-4 py-4 md:py-8 z-10 w-full h-full">
        
        <!-- HOME VIEW -->
        <div id="view-home" class="view-section flex-col items-center gap-8 md:gap-16 active">
            <section id="home" class="text-center max-w-4xl space-y-6 mt-4 md:mt-10">
                <div class="inline-block px-4 py-1 rounded-full bg-surface border border-border text-sm text-pink-400 mb-4 animate-bounce shadow-[0_0_15px_rgba(236,72,153,0.3)]" data-i18n="meet_companion">
                    ‚ú® Intelligent Multi-Agent Engine
                </div>
                <h1 class="text-4xl md:text-6xl font-bold leading-[1.6] md:leading-[1.6] py-4">
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-500 inline-block text-glow-anim" data-i18n="brand_name">Ciel</span>
                </h1>
                <p class="text-xl text-txt-muted drop-shadow-md" data-i18n="hero_desc">
                    ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ AI ‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏á‡πà‡∏≤‡∏¢ ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏û‡∏£‡∏¥‡∏ö‡∏ï‡∏≤
                </p>
                
                <button onclick="navigateTo('chat')" class="mt-8 px-8 py-4 bg-gradient-to-r from-pink-600 to-violet-600 text-white rounded-full font-bold text-lg shadow-[0_0_30px_rgba(236,72,153,0.4)] hover:scale-105 hover:shadow-[0_0_50px_rgba(236,72,153,0.7)] transition-all duration-300" data-i18n="start_chatting_btn">
                    Launch Orchestrator üöÄ
                </button>
            </section>

            <!-- Guide Section with Tabs -->
            <section class="w-full max-w-5xl mt-8 md:mt-12 pb-0">
                <!-- Tab Buttons -->
                <div class="flex justify-center flex-wrap gap-2 mb-8 bg-surface/50 p-1.5 rounded-full inline-flex mx-auto border border-border/50 backdrop-blur-md">
                    <button onclick="switchTab('usage')" id="tab-usage" class="tab-btn active text-sm md:text-base flex items-center gap-2">
                        <i data-lucide="cpu" class="w-4 h-4"></i> <span data-i18n="tab_ai_guide">System Logic</span>
                    </button>
                    <button onclick="switchTab('github')" id="tab-github" class="tab-btn text-sm md:text-base flex items-center gap-2">
                        <i data-lucide="github" class="w-4 h-4"></i> <span data-i18n="tab_github">GitHub</span>
                    </button>
                    <button onclick="switchTab('project')" id="tab-project" class="tab-btn text-sm md:text-base flex items-center gap-2">
                        <i data-lucide="folder-plus" class="w-4 h-4"></i> <span data-i18n="tab_project">New Project</span>
                    </button>
                </div>

                <!-- Content: AI Usage Guide -->
                <div id="content-usage" class="grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in">
                    <!-- Step 1 -->
                    <div class="bg-surface/50 p-6 rounded-2xl border border-border hover:border-pink-500/50 transition duration-300 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                            <span class="text-6xl font-bold text-pink-500">01</span>
                        </div>
                        <div class="w-12 h-12 bg-pink-500/20 rounded-xl flex items-center justify-center mb-4 text-pink-400">
                            <i data-lucide="search" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2 text-txt-main" data-i18n="guide_step1_title">Research Agent</h3>
                        <p class="text-txt-muted text-sm" data-i18n="guide_step1_desc">
                            Parses unstructured PDF data and validates factual accuracy via OpenRouter & Wikipedia.
                        </p>
                    </div>

                    <!-- Step 2 -->
                    <div class="bg-surface/50 p-6 rounded-2xl border border-border hover:border-violet-500/50 transition duration-300 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                            <span class="text-6xl font-bold text-violet-500">02</span>
                        </div>
                        <div class="w-12 h-12 bg-violet-500/20 rounded-xl flex items-center justify-center mb-4 text-violet-400">
                            <i data-lucide="code" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2 text-txt-main" data-i18n="guide_step2_title">Technical Synthesis</h3>
                        <p class="text-txt-muted text-sm" data-i18n="guide_step2_desc">
                            Functions as an intelligent tutor, generating executable code (Python/JS) and pedagogical guides.
                        </p>
                    </div>

                    <!-- Step 3 -->
                    <div class="bg-surface/50 p-6 rounded-2xl border border-border hover:border-blue-500/50 transition duration-300 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                            <span class="text-6xl font-bold text-blue-500">03</span>
                        </div>
                        <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center mb-4 text-blue-400">
                            <i data-lucide="palette" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2 text-txt-main" data-i18n="guide_step3_title">Creative Agent</h3>
                        <p class="text-txt-muted text-sm" data-i18n="guide_step3_desc">
                            Synthesizes research into engaging narratives and precise Text-to-Image prompts using Gemini.
                        </p>
                    </div>

                    <!-- Step 4 -->
                    <div class="bg-surface/50 p-6 rounded-2xl border border-border hover:border-emerald-500/50 transition duration-300 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                            <span class="text-6xl font-bold text-emerald-500">04</span>
                        </div>
                        <div class="w-12 h-12 bg-emerald-500/20 rounded-xl flex items-center justify-center mb-4 text-emerald-400">
                            <i data-lucide="brain-circuit" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2 text-txt-main" data-i18n="guide_step4_title">Adaptive Learning</h3>
                        <p class="text-txt-muted text-sm" data-i18n="guide_step4_desc">
                            Utilizes memory to learn from feedback, adapting teaching styles and coding patterns over time.
                        </p>
                    </div>
                </div>

                <!-- Content: GitHub Signup Guide -->
                <div id="content-github" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in">
                    <!-- GitHub Step 1 -->
                    <div class="bg-surface/50 p-6 rounded-2xl border border-border hover:border-white/50 transition duration-300 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                            <span class="text-6xl font-bold text-white">01</span>
                        </div>
                        <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center mb-4 text-white">
                            <i data-lucide="globe" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2 text-txt-main" data-i18n="gh_step1_title">Go to Website</h3>
                        <p class="text-txt-muted text-sm" data-i18n="gh_step1_desc">
                            Visit <strong>github.com</strong> and click on the "Sign up" button at the top right corner.
                        </p>
                    </div>

                    <!-- GitHub Step 2 -->
                    <div class="bg-surface/50 p-6 rounded-2xl border border-border hover:border-white/50 transition duration-300 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                            <span class="text-6xl font-bold text-white">02</span>
                        </div>
                        <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center mb-4 text-white">
                            <i data-lucide="mail" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2 text-txt-main" data-i18n="gh_step2_title">Enter Details</h3>
                        <p class="text-txt-muted text-sm" data-i18n="gh_step2_desc">
                            Enter your email address, create a strong password, and choose a unique username.
                        </p>
                    </div>

                    <!-- GitHub Step 3 -->
                    <div class="bg-surface/50 p-6 rounded-2xl border border-border hover:border-white/50 transition duration-300 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                            <span class="text-6xl font-bold text-white">03</span>
                        </div>
                        <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center mb-4 text-white">
                            <i data-lucide="shield-check" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2 text-txt-main" data-i18n="gh_step3_title">Verify Account</h3>
                        <p class="text-txt-muted text-sm" data-i18n="gh_step3_desc">
                            Complete the puzzle challenge to prove you are human, then check your email for the launch code.
                        </p>
                    </div>

                    <!-- GitHub Step 4 -->
                    <div class="bg-surface/50 p-6 rounded-2xl border border-border hover:border-white/50 transition duration-300 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                            <span class="text-6xl font-bold text-white">04</span>
                        </div>
                        <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center mb-4 text-white">
                            <i data-lucide="check-circle" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2 text-txt-main" data-i18n="gh_step4_title">Complete</h3>
                        <p class="text-txt-muted text-sm" data-i18n="gh_step4_desc">
                            Enter the code from email. You are now ready to create your first repository!
                        </p>
                    </div>
                </div>

                <!-- Content: Create Project Guide (New) -->
                <div id="content-project" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in">
                    <!-- Project Step 1 -->
                    <div class="bg-surface/50 p-6 rounded-2xl border border-border hover:border-green-500/50 transition duration-300 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                            <span class="text-6xl font-bold text-green-500">01</span>
                        </div>
                        <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center mb-4 text-green-400">
                            <i data-lucide="plus-square" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2 text-txt-main" data-i18n="proj_step1_title">Create New Repo</h3>
                        <p class="text-txt-muted text-sm" data-i18n="proj_step1_desc">
                            Log in to GitHub. Click the "+" icon in the top-right corner and select "New repository".
                        </p>
                    </div>

                    <!-- Project Step 2 -->
                    <div class="bg-surface/50 p-6 rounded-2xl border border-border hover:border-green-500/50 transition duration-300 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                            <span class="text-6xl font-bold text-green-500">02</span>
                        </div>
                        <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center mb-4 text-green-400">
                            <i data-lucide="edit-3" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2 text-txt-main" data-i18n="proj_step2_title">Name & Info</h3>
                        <p class="text-txt-muted text-sm" data-i18n="proj_step2_desc">
                            Enter a "Repository name". Add a description (optional) to explain your project.
                        </p>
                    </div>

                    <!-- Project Step 3 -->
                    <div class="bg-surface/50 p-6 rounded-2xl border border-border hover:border-green-500/50 transition duration-300 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                            <span class="text-6xl font-bold text-green-500">03</span>
                        </div>
                        <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center mb-4 text-green-400">
                            <i data-lucide="lock" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2 text-txt-main" data-i18n="proj_step3_title">Visibility</h3>
                        <p class="text-txt-muted text-sm" data-i18n="proj_step3_desc">
                            Choose "Public" (everyone can see) or "Private" (only you can see). Public is free and good for portfolios.
                        </p>
                    </div>

                    <!-- Project Step 4 -->
                    <div class="bg-surface/50 p-6 rounded-2xl border border-border hover:border-green-500/50 transition duration-300 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                            <span class="text-6xl font-bold text-green-500">04</span>
                        </div>
                        <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center mb-4 text-green-400">
                            <i data-lucide="check" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2 text-txt-main" data-i18n="proj_step4_title">Create</h3>
                        <p class="text-txt-muted text-sm" data-i18n="proj_step4_desc">
                            Click "Create repository". Done! You can now upload files or push code to your new project.
                        </p>
                    </div>
                </div>
            </section>
            
            <div class="mb-20"></div> 
        </div>

        <!-- CHAT VIEW (UPDATED LAYOUT) -->
        <div id="view-chat" class="view-section flex-col items-center h-screen md:pt-4 pb-4 px-2 md:px-4">
            <div class="w-full max-w-7xl flex gap-4 h-full relative">
                
                <!-- Sidebar (History) -->
                <aside id="chat-sidebar" class="hidden md:flex flex-col w-64 bg-surface/80 backdrop-blur-xl border border-border rounded-3xl shadow-xl overflow-hidden transition-all absolute md:static inset-y-0 left-0 z-40 md:z-30 transform -translate-x-full md:translate-x-0 h-full">
                    <div class="p-4 border-b border-border flex justify-between items-center bg-surface2/30">
                        <h3 class="font-bold text-txt-main flex items-center gap-2">
                            <i data-lucide="history" class="w-4 h-4 text-pink-500"></i> History
                        </h3>
                        <button onclick="createNewSession()" class="p-2 hover:bg-surface2 rounded-full text-txt-main transition shadow-sm border border-border/50" title="New Chat">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div id="session-list" class="flex-1 overflow-y-auto p-2 space-y-2 chat-container">
                        <!-- Items will be injected here -->
                    </div>
                </aside>

                <!-- Overlay for Mobile Sidebar -->
                <div id="sidebar-overlay" onclick="toggleChatSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden glass"></div>

                <!-- Main Chat Area -->
                <section class="flex-1 bg-surface/80 backdrop-blur-xl border border-border rounded-3xl shadow-xl overflow-hidden flex flex-col relative h-full">
                    <div class="bg-surface p-3 md:p-4 flex items-center gap-4 border-b border-border z-10 shadow-md">
                        <!-- Back button (Mobile view logic) -->
                        <button onclick="navigateTo('home')" class="md:hidden text-txt-muted hover:text-txt-main mr-1 p-1 rounded-full hover:bg-surface2">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        </button>
                        
                        <!-- Toggle Sidebar Button (Mobile) -->
                        <button onclick="toggleChatSidebar()" class="md:hidden text-txt-main p-2 hover:bg-surface2 rounded-full">
                            <i data-lucide="panel-left" class="w-5 h-5"></i>
                        </button>

                        <div class="relative group cursor-pointer flex-shrink-0" onclick="document.getElementById('avatar-upload').click()" title="Click to change avatar">
                            <div id="header-avatar" class="w-10 h-10 md:w-12 md:h-12 rounded-full bg-gradient-to-tr from-pink-500 to-violet-600 flex items-center justify-center text-lg font-bold text-white shadow-lg overflow-hidden border border-border">
                                ‡∏ï
                            </div>
                            <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <i data-lucide="camera" class="w-4 h-4 text-white"></i>
                            </div>
                            <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-surface"></div>
                        </div>
                        <div class="flex-grow min-w-0 flex flex-col gap-0.5">
                            <div class="flex items-center gap-2 relative">
                                <h3 class="font-bold text-base md:text-lg truncate" data-i18n="brand_name">Ciel</h3>
                                <!-- CUSTOM AGENT SELECTOR -->
                                <div class="relative z-50">
                                    <button onclick="toggleAgentMenu()" id="agent-btn" class="group flex items-center gap-2 bg-surface/50 hover:bg-surface border border-white/10 hover:border-pink-500/30 rounded-full pl-3 pr-2 py-1.5 transition-all duration-300 backdrop-blur-md shadow-sm">
                                        <div class="w-2 h-2 rounded-full bg-gradient-to-r from-pink-500 to-violet-500 animate-pulse"></div>
                                        <span id="current-agent-label" class="text-xs font-bold text-txt-main group-hover:text-pink-100 transition-colors">Ciel (Main)</span>
                                        <div class="bg-surface2/50 rounded-full p-0.5 ml-1">
                                            <i data-lucide="chevron-down" class="w-3 h-3 text-txt-muted group-hover:text-txt-main transition-transform group-hover:rotate-180 duration-300"></i>
                                        </div>
                                    </button>
                                    
                                    <!-- Dropdown Menu with Animation -->
                                    <div id="agent-dropdown" class="hidden absolute top-full left-0 mt-2 w-56 bg-surface/95 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl overflow-hidden transform origin-top-left transition-all duration-200 opacity-0 scale-95 pointer-events-none">
                                        <div class="p-1.5 space-y-1">
                                            <div class="px-3 py-2 text-[10px] uppercase tracking-wider text-txt-muted font-bold border-b border-white/5 mb-1">
                                                Select Model
                                            </div>
                                            <button onclick="selectAgent('ciel')" class="w-full text-left px-3 py-2.5 rounded-xl hover:bg-white/5 hover:text-white text-xs text-txt-sec transition-all flex items-center gap-3 group relative overflow-hidden">
                                                <div class="absolute inset-0 bg-gradient-to-r from-pink-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-pink-500 to-rose-600 flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                                                    <span class="text-white font-bold text-xs">C1</span>
                                                </div>
                                                <div class="flex flex-col">
                                                    <span class="font-bold text-txt-main">Ciel (Main)</span>
                                                    <span class="text-[10px] text-txt-muted">General Purpose</span>
                                                </div>
                                                <i data-lucide="check" class="w-3 h-3 text-pink-400 ml-auto opacity-0 check-icon-ciel"></i>
                                            </button>

                                            <button onclick="selectAgent('agent2')" class="w-full text-left px-3 py-2.5 rounded-xl hover:bg-white/5 hover:text-white text-xs text-txt-sec transition-all flex items-center gap-3 group relative overflow-hidden">
                                                <div class="absolute inset-0 bg-gradient-to-r from-violet-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-violet-500 to-indigo-600 flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                                                    <span class="text-white font-bold text-xs">C2</span>
                                                </div>
                                                <div class="flex flex-col">
                                                    <span class="font-bold text-txt-main">Ciel (Pro)</span>
                                                    <span class="text-[10px] text-txt-muted">Advanced Logic</span>
                                                </div>
                                                <i data-lucide="check" class="w-3 h-3 text-violet-400 ml-auto opacity-0 check-icon-agent2"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p class="text-xs text-txt-muted flex items-center gap-1">
                                <i id="status-icon" data-lucide="zap" class="w-3 h-3 text-yellow-400"></i> <span id="bot-status-text" data-i18n="online_ready">Active</span>
                            </p>
                        </div>
                        
                        <button onclick="triggerClearChat()" class="p-2 text-red-400 hover:text-red-300 hover:bg-surface2/50 rounded-full transition flex items-center justify-center" title="Clear Chat">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <div id="messages" class="flex-1 p-4 md:p-6 overflow-y-auto chat-container space-y-4 bg-background/50 pb-20 md:pb-6">
                        <!-- Messages go here -->
                    </div>

                    <!-- Enhanced File Preview Container -->
                    <div id="file-preview-container" class="hidden px-4 pt-2 bg-surface/50 border-t border-border">
                        <div class="relative inline-flex items-center gap-3 p-2 bg-surface2/50 rounded-xl border border-border/50">
                            <img id="image-preview-element" alt="Preview" class="hidden h-14 w-auto rounded-lg object-contain border border-border">
                            <div id="file-preview-icon" class="hidden w-10 h-10 bg-surface2 rounded-lg flex items-center justify-center text-txt-sec">
                                <i data-lucide="file-text" class="w-6 h-6"></i>
                            </div>
                            <div class="flex flex-col">
                                <span id="preview-filename" class="text-xs text-txt-main font-medium max-w-[150px] truncate"></span>
                                <span id="preview-filesize" class="text-[10px] text-txt-muted"></span>
                            </div>
                            <button id="clear-file-btn" onclick="clearFileSelection(true)" class="ml-2 p-1 bg-surface2 hover:bg-red-500/80 text-white rounded-full transition shadow-sm">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>

                    <div class="p-3 md:p-4 bg-surface border-t border-border z-10 shadow-[0_-5px_15px_rgba(0,0,0,0.3)]">
                        <form id="chat-form" class="flex gap-2 items-end">
                            <input type="file" id="file-input" class="hidden" onchange="handleFileSelect(event)">
                            <button type="button" onclick="document.getElementById('file-input').click()" class="p-3 text-txt-muted hover:text-pink-400 hover:bg-surface2 rounded-xl transition flex-shrink-0" title="Upload File">
                                <i data-lucide="paperclip" class="w-6 h-6"></i>
                            </button>
                            <div class="flex-grow relative">
                                <textarea 
                                    id="user-input" 
                                    rows="1"
                                    placeholder="Message Ciel..." 
                                    class="w-full bg-background text-txt-main border-0 rounded-xl px-4 py-3 focus:ring-2 focus:ring-pink-500 resize-none outline-none placeholder-txt-muted"
                                    style="min-height: 48px; max-height: 120px;"
                                    onkeydown="handleEnter(event)"
                                ></textarea>
                            </div>
                            <button type="submit" id="send-btn" class="p-3 bg-gradient-to-r from-pink-600 to-violet-600 hover:from-pink-500 hover:to-violet-500 text-white rounded-xl shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0">
                                <i data-lucide="send-horizontal" class="w-6 h-6"></i>
                            </button>
                        </form>
                    </div>
                </section>
            </div>
        </div>

    </main>

    <footer id="main-footer" class="text-center p-8 text-txt-muted text-sm z-10 mobile-hide" data-i18n="footer">
        &copy; 2024 Ciel. All rights reserved.
    </footer>

    <script>
        // --- Global Variables ---
        let currentLang = localStorage.getItem('app_language') || 'th';
        let currentTheme = localStorage.getItem('app_theme') || 'default';
        let sessionId = localStorage.getItem('active_session_id'); // Changed from chat_session_id
        let chatHistory = [];
        let sessions = []; // List of all sessions
        let currentUser = null;
        let selectedFile = null;
        let botAvatarUrl = localStorage.getItem('bot_avatar');
        let confirmAction = null;

        // --- Multi-Agent Logic ---
        const API_ENDPOINTS = {
            'ciel': 'https://laassx.app.n8n.cloud/webhook/20f1e0a0-71ed-4fa0-a696-373e4c4f84eb/chat',
            'agent2': 'https://laassx.app.n8n.cloud/webhook/cb80b9ee-4ac3-4f31-9a12-46398f8ea1b7/chat'
        };
        const AGENT_LABELS = {
            'ciel': 'Ciel (Main)',
            'agent2': 'Ciel (Pro)'
        };
        let currentAgent = localStorage.getItem('current_agent') || 'ciel';

        window.toggleAgentMenu = function() {
            const drop = document.getElementById('agent-dropdown');
            if (drop.classList.contains('hidden')) {
                drop.classList.remove('hidden');
                setTimeout(() => {
                    drop.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
                    drop.classList.add('opacity-100', 'scale-100', 'pointer-events-auto');
                }, 10);
            } else {
                drop.classList.remove('opacity-100', 'scale-100', 'pointer-events-auto');
                drop.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
                setTimeout(() => drop.classList.add('hidden'), 200);
            }
        };

        window.selectAgent = function(agentKey) {
            currentAgent = agentKey;
            localStorage.setItem('current_agent', agentKey);
            
            // Update UI
            document.getElementById('current-agent-label').innerText = AGENT_LABELS[agentKey];
            
            // Update Checkmarks
            document.querySelectorAll('[class*="check-icon-"]').forEach(el => el.classList.add('opacity-0'));
            const activeCheck = document.querySelector(`.check-icon-${agentKey}`);
            if(activeCheck) activeCheck.classList.remove('opacity-0');

            // Close Menu
            toggleAgentMenu();
        };

        window.switchAgent = function(agentKey) {
            selectAgent(agentKey);
        };

        // Initialize selector on load
        window.addEventListener('DOMContentLoaded', () => {
            if(currentAgent && AGENT_LABELS[currentAgent]) {
                document.getElementById('current-agent-label').innerText = AGENT_LABELS[currentAgent];
                const activeCheck = document.querySelector(`.check-icon-${currentAgent}`);
                if(activeCheck) activeCheck.classList.remove('opacity-0');
            }
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                const btn = document.getElementById('agent-btn');
                const drop = document.getElementById('agent-dropdown');
                if(btn && drop && !btn.contains(e.target) && !drop.contains(e.target) && !drop.classList.contains('hidden')) {
                    toggleAgentMenu();
                }
            });
        });


        try {
            const userStr = localStorage.getItem('user_profile');
            if (userStr) currentUser = JSON.parse(userStr);
        } catch(e) { console.error("User profile corrupt", e); }

        // --- Translations ---
        const translations = {
            en: {
                home: "Home", about: "About", ai_friend: "Ciel", chat_now: "Launch Ciel",
                meet_companion: "‚ú® Intelligent Multi-Agent Engine", hero_title_prefix: "",
                hero_desc: "Developing a precise information retrieval assistant web app bot.",
                brand_nav: "Ciel", brand_name: "Ciel", online_ready: "System Active",
                welcome_msg: "Hello! I'm Ciel. üëã",
                welcome_sub: "I'm your Multi-Agent Orchestration Engine. Upload a PDF to start researching, or ask me to generate code.",
                placeholder_input: "Message Ciel...", powered_by: "Powered by n8n Webhook",
                footer: "¬© 2024 Ciel. All rights reserved.",
                error_msg: "‚ö†Ô∏è System Alert: Connection to Orchestrator failed. Please retry.",
                you: "You", start_chatting_btn: "Launch Orchestrator üöÄ", 
                how_to_use: "System Logic",
                login_title: "Welcome Back", login_subtitle: "Access your dashboard", btn_login: "Sign In",
                signup_title: "Create Account", signup_subtitle: "Join the network", btn_signup: "Create Account",
                
                // Ciel Logic Guide
                guide_step1_title: "Research Agent", guide_step1_desc: "Parses unstructured PDF data and validates factual accuracy via OpenRouter & Wikipedia.",
                guide_step2_title: "Technical Synthesis", guide_step2_desc: "Functions as an intelligent tutor, generating executable code (Python/JS) and pedagogical guides.",
                guide_step3_title: "Creative Agent", guide_step3_desc: "Synthesizes research into engaging narratives and precise Text-to-Image prompts using Gemini.",
                guide_step4_title: "Adaptive Learning", guide_step4_desc: "Utilizes memory to learn from feedback, adapting teaching styles and coding patterns over time.",
                
                // Tabs
                tab_ai_guide: "System Logic", tab_github: "GitHub", tab_project: "New Project",
                
                // GitHub Guide
                gh_step1_title: "Go to Website", gh_step1_desc: "Visit github.com and click 'Sign up'.",
                gh_step2_title: "Enter Details", gh_step2_desc: "Enter email, password, and username.",
                gh_step3_title: "Verify", gh_step3_desc: "Solve puzzle and verify email code.",
                gh_step4_title: "Complete", gh_step4_desc: "You are ready to code!",
                
                // Project Guide
                proj_step1_title: "Create New Repo", proj_step1_desc: "Log in. Click '+' icon top-right > 'New repository'.",
                proj_step2_title: "Name & Info", proj_step2_desc: "Enter 'Repository name'. Add a description (optional).",
                proj_step3_title: "Visibility", proj_step3_desc: "Select 'Public' (for portfolio) or 'Private'.",
                proj_step4_title: "Create", proj_step4_desc: "Click 'Create repository'. You're ready to upload files!"
            },
            th: {
                home: "‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å", about: "‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö", ai_friend: "Ciel", chat_now: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
                meet_companion: "‚ú® ‡∏£‡∏∞‡∏ö‡∏ö Multi-Agent ‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞", hero_title_prefix: "",
                hero_desc: "‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ AI ‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏á‡πà‡∏≤‡∏¢ ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏û‡∏£‡∏¥‡∏ö‡∏ï‡∏≤",
                brand_nav: "Ciel", brand_name: "Ciel", online_ready: "‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
                welcome_msg: "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ Ciel üëã",
                welcome_sub: "‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö Multi-Agent Orchestration ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå PDF ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏à‡∏±‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö",
                placeholder_input: "‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô Ciel...", powered_by: "‡∏Ç‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÇ‡∏î‡∏¢ n8n Webhook",
                footer: "¬© 2024 Ciel. ‡∏™‡∏á‡∏ß‡∏ô‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå",
                error_msg: "‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á",
                you: "‡∏Ñ‡∏∏‡∏ì", start_chatting_btn: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö üöÄ", 
                how_to_use: "‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö",
                login_title: "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö", login_subtitle: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô", btn_login: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
                signup_title: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà", signup_subtitle: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢", btn_signup: "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å",
                
                // Ciel Logic Guide (TH)
                guide_step1_title: "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î (Write Code)", guide_step1_desc: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î Python, JavaScript ‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡πä‡∏Å",
                guide_step2_title: "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Analyze)", guide_step2_desc: "‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å",
                guide_step3_title: "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (Calculate)", guide_step3_desc: "‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏≤‡∏á‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡πÅ‡∏Å‡πâ‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô",
                guide_step4_title: "‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (Inquiry)", guide_step4_desc: "‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏π‡πà‡∏Ñ‡∏¥‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏î‡∏°‡∏™‡∏°‡∏≠‡∏á",
                
                // Tabs
                tab_ai_guide: "‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏´‡∏•‡∏±‡∏Å", tab_github: "‡∏™‡∏°‡∏±‡∏Ñ‡∏£ GitHub", tab_project: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ",
                
                // GitHub Guide
                gh_step1_title: "‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå", gh_step1_desc: "‡πÑ‡∏õ‡∏ó‡∏µ‡πà github.com ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° 'Sign up' ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô",
                gh_step2_title: "‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", gh_step2_desc: "‡πÉ‡∏™‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏• ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏î‡∏Å‡∏∏‡∏° ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)",
                gh_step3_title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô", gh_step3_desc: "‡πÅ‡∏Å‡πâ‡∏õ‡∏£‡∏¥‡∏®‡∏ô‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô ‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡∏£‡∏´‡∏±‡∏™‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏°‡∏≤‡∏Å‡∏£‡∏≠‡∏Å",
                gh_step4_title: "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô", gh_step4_desc: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á Repository ‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì!",
                
                // Project Guide
                proj_step1_title: "‡∏™‡∏£‡πâ‡∏≤‡∏á Repo ‡πÉ‡∏´‡∏°‡πà", proj_step1_desc: "‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô GitHub ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ '+' ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô > ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 'New repository'",
                proj_step2_title: "‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ", proj_step2_desc: "‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á 'Repository name' ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ (Description)",
                proj_step3_title: "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô", proj_step3_desc: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Public (‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ/‡∏ü‡∏£‡∏µ) ‡∏´‡∏£‡∏∑‡∏≠ Private (‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß) ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£",
                proj_step4_title: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏¢!", proj_step4_desc: "‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° 'Create repository' ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î ‡∏Å‡πá‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö"
            }
        };

        // --- UI Helper Functions ---
        window.updateContent = function() {
            const t = translations[currentLang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.innerText = t[key];
            });
            const userInput = document.getElementById('user-input');
            if(userInput) userInput.placeholder = t.placeholder_input;
            const langLabel = document.getElementById('lang-label');
            if(langLabel) langLabel.innerText = currentLang === 'en' ? 'TH' : 'EN';
        };

        window.toggleLanguage = function() {
            currentLang = currentLang === 'en' ? 'th' : 'en';
            localStorage.setItem('app_language', currentLang);
            updateContent();
            updateChatWelcomeMessage(); 
        };

        window.applyTheme = function(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('app_theme', theme);
        };

        window.toggleTheme = function() {
            if (currentTheme === 'default') currentTheme = 'light';
            else if (currentTheme === 'light') currentTheme = 'midnight';
            else currentTheme = 'default';
            applyTheme(currentTheme);
        };

        function updateChatWelcomeMessage() {
             const welcomeMsg = document.querySelector('[data-i18n="welcome_msg"]');
             const welcomeSub = document.querySelector('[data-i18n="welcome_sub"]');
             if(welcomeMsg) welcomeMsg.innerText = translations[currentLang].welcome_msg;
             if(welcomeSub) welcomeSub.innerText = translations[currentLang].welcome_sub;
        }

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            
            document.getElementById('content-usage').classList.add('hidden');
            document.getElementById('content-github').classList.add('hidden');
            document.getElementById('content-project').classList.add('hidden');
            document.getElementById('content-' + tabName).classList.remove('hidden');
        };

        window.navigateTo = function(viewId) {
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
                setTimeout(() => { if(!el.classList.contains('active')) el.style.display = 'none'; }, 300);
            });
            const selected = document.getElementById('view-' + viewId);
            selected.style.display = 'flex';
            setTimeout(() => selected.classList.add('active'), 10);
            
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('nav-btn-active'));
            const activeBtn = document.getElementById('nav-' + viewId);
            if(activeBtn) activeBtn.classList.add('nav-btn-active');
            window.scrollTo({ top: 0, behavior: 'smooth' });

            if (viewId === 'chat') {
                document.body.classList.add('in-chat');
                scrollToBottom();
                renderSessionList(); // Refresh session list when entering chat
            } else {
                document.body.classList.remove('in-chat');
            }
        };

        // --- Sidebar Logic ---
        window.toggleChatSidebar = function() {
            const sidebar = document.getElementById('chat-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            // Check if currently closed (based on transform class or hidden state)
            const isClosed = sidebar.classList.contains('-translate-x-full') || sidebar.classList.contains('hidden');
            
            if (isClosed) {
                // Open Sidebar
                sidebar.classList.remove('hidden');
                sidebar.classList.add('flex');
                
                // Force reflow to ensure transition works
                void sidebar.offsetWidth;
                
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                
                // On mobile, sidebar should be absolute and high z-index
                if(window.innerWidth < 768) {
                    sidebar.classList.add('absolute');
                    // sidebar.classList.add('z-50'); 
                }
            } else {
                // Close Sidebar
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
                
                // Wait for animation to finish then hide element
                setTimeout(() => {
                    if(window.innerWidth < 768) {
                        sidebar.classList.add('hidden');
                        sidebar.classList.remove('flex');
                        // sidebar.classList.remove('z-50');
                    }
                }, 300);
            }
        };

        // --- Session Management ---
        function loadSessions() {
            try {
                // Migration: If legacy chat_history exists but no sessions, create one
                const legacyHistory = localStorage.getItem('chat_history');
                const storedSessions = localStorage.getItem('ciel_sessions');
                
                if (legacyHistory && !storedSessions) {
                    const newId = crypto.randomUUID();
                    const newSession = {
                        id: newId,
                        title: 'Legacy Chat',
                        timestamp: Date.now()
                    };
                    sessions = [newSession];
                    localStorage.setItem('ciel_sessions', JSON.stringify(sessions));
                    localStorage.setItem(`ciel_chat_${newId}`, legacyHistory);
                    localStorage.removeItem('chat_history');
                    sessionId = newId;
                } else if (storedSessions) {
                    sessions = JSON.parse(storedSessions);
                }
                
                if (!sessionId && sessions.length > 0) {
                    sessionId = sessions[0].id;
                }
                
                if (!sessionId && sessions.length === 0) {
                    createNewSession(false); // Create default if nothing exists
                }

                localStorage.setItem('active_session_id', sessionId);

            } catch(e) { console.error("Session load error", e); }
        }

        window.createNewSession = function(render = true) {
            const newId = crypto.randomUUID();
            const newSession = {
                id: newId,
                title: 'New Chat',
                timestamp: Date.now()
            };
            sessions.unshift(newSession); // Add to top
            sessionId = newId;
            localStorage.setItem('ciel_sessions', JSON.stringify(sessions));
            localStorage.setItem('active_session_id', sessionId);
            
            chatHistory = []; // Empty history for new session
            
            if(render) {
                renderSessionList();
                renderChatHistory(); // Clear chat view
                if(window.innerWidth < 768) toggleChatSidebar(); // Close sidebar on mobile
            }
        };

        window.switchSession = function(id) {
            sessionId = id;
            localStorage.setItem('active_session_id', id);
            renderSessionList(); // Update active state
            loadChatHistory(); // Load messages for this ID
            renderChatHistory(); // Render them
            if(window.innerWidth < 768) toggleChatSidebar();
        };

        window.deleteSession = function(e, id) {
            e.stopPropagation(); // Prevent clicking the item
            
            showConfirmModal(
                currentLang === 'en' ? 'Delete Chat?' : '‡∏•‡∏ö‡πÅ‡∏ä‡∏ó?',
                currentLang === 'en' ? 'Remove this conversation permanently?' : '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?',
                () => {
                    sessions = sessions.filter(s => s.id !== id);
                    localStorage.setItem('ciel_sessions', JSON.stringify(sessions));
                    localStorage.removeItem(`ciel_chat_${id}`); // Remove message data
                    
                    // If deleted active session, switch to another or create new
                    if (sessionId === id) {
                        if (sessions.length > 0) {
                            switchSession(sessions[0].id);
                        } else {
                            createNewSession();
                        }
                    } else {
                        renderSessionList();
                    }
                }
            );
        };

        function renderSessionList() {
            const container = document.getElementById('session-list');
            if(!container) return;
            container.innerHTML = '';
            
            sessions.forEach(session => {
                const div = document.createElement('div');
                div.className = `session-item group ${session.id === sessionId ? 'active-session' : 'text-txt-sec'}`;
                div.onclick = () => switchSession(session.id);
                
                div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <i data-lucide="message-square" class="w-4 h-4 flex-shrink-0 ${session.id === sessionId ? 'text-pink-500' : 'text-txt-muted'}"></i>
                        <span class="truncate text-sm font-medium">${session.title}</span>
                    </div>
                    <button class="delete-btn" onclick="deleteSession(event, '${session.id}')">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                container.appendChild(div);
            });
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        // --- Standard UI Logic ---
        window.toggleMobileMenu = function() {
            const menu = document.getElementById('mobile-menu');
            const icon = document.getElementById('mobile-menu-icon');
            
            if (menu.classList.contains('hidden-menu')) {
                menu.classList.remove('hidden-menu');
                icon.setAttribute('data-lucide', 'x');
            } else {
                menu.classList.add('hidden-menu');
                icon.setAttribute('data-lucide', 'menu');
            }
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.toggleProfileMenu = function() {
            document.getElementById('profile-dropdown').classList.toggle('hidden');
        };

        window.openAuthModal = function() {
            document.getElementById('auth-modal').classList.add('active');
            toggleAuthMode('login');
        };
        window.closeAuthModal = function() { document.getElementById('auth-modal').classList.remove('active'); };
        
        window.toggleAuthMode = function(mode) {
            const login = document.getElementById('login-form');
            const signup = document.getElementById('signup-form');
            if(mode === 'signup') { login.classList.add('hidden'); signup.classList.remove('hidden'); }
            else { signup.classList.add('hidden'); login.classList.remove('hidden'); }
        };

        window.handleLogin = function(e) {
            if(e) e.preventDefault();
            const emailIn = document.getElementById('login-email').value;
            const namePart = emailIn.split('@')[0];
            currentUser = { name: namePart, email: emailIn };
            localStorage.setItem('user_profile', JSON.stringify(currentUser));
            updateAuthUI();
            closeAuthModal();
        };

        window.handleSignup = function(e) { 
            if(e) e.preventDefault();
            const nameIn = document.getElementById('signup-name').value;
            const emailIn = document.getElementById('signup-email').value;
            currentUser = { name: nameIn, email: emailIn };
            localStorage.setItem('user_profile', JSON.stringify(currentUser));
            updateAuthUI();
            closeAuthModal();
        };

        window.logout = function() {
            currentUser = null;
            localStorage.removeItem('user_profile');
            updateAuthUI();
            document.getElementById('profile-dropdown').classList.add('hidden');
        };

        function updateAuthUI() {
            const desktopBtn = document.getElementById('auth-buttons-desktop');
            const mobileBtn = document.getElementById('auth-buttons-mobile');
            const profileMenu = document.getElementById('user-profile-menu');
            const mobileActions = document.getElementById('auth-actions-mobile');

            if(currentUser) {
                if(desktopBtn) {
                    desktopBtn.classList.remove('md:block');
                    desktopBtn.classList.add('hidden');
                }
                if(mobileBtn) mobileBtn.classList.add('hidden');
                
                if(profileMenu) profileMenu.classList.remove('hidden');
                if(mobileActions) mobileActions.classList.remove('hidden');
                
                document.getElementById('nav-user-name').innerText = currentUser.name;
                document.getElementById('mobile-user-name').innerText = currentUser.name;
                document.getElementById('dropdown-email').innerText = currentUser.email;
                if(currentUser.avatar) {
                    const avatarHtml = `<img src="${currentUser.avatar}" class="w-full h-full object-cover">`;
                    document.getElementById('nav-user-avatar').innerHTML = avatarHtml;
                }
            } else {
                if(desktopBtn) {
                    desktopBtn.classList.remove('hidden');
                    desktopBtn.classList.add('md:block');
                }
                if(mobileBtn) mobileBtn.classList.remove('hidden');
                
                if(profileMenu) profileMenu.classList.add('hidden');
                if(mobileActions) mobileActions.classList.add('hidden');
            }
        }

        window.triggerClearChat = function() {
            showConfirmModal(
                currentLang === 'en' ? 'Clear History?' : '‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ä‡∏ó?',
                currentLang === 'en' ? 'Delete messages in this chat?' : '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?',
                () => {
                    chatHistory = [];
                    saveCurrentChat();
                    renderChatHistory();
                }
            );
        };
        
        window.triggerDeleteAccount = function() {
            showConfirmModal(
                currentLang === 'en' ? 'Delete Account?' : '‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ?',
                currentLang === 'en' ? 'This cannot be undone.' : '‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ',
                () => {
                    localStorage.clear();
                    window.location.reload();
                }
            );
        };

        function showConfirmModal(title, msg, callback) {
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-message').innerText = msg;
            confirmAction = callback;
            document.getElementById('confirm-modal').classList.add('active');
        }

        window.closeConfirmModal = function() { 
            document.getElementById('confirm-modal').classList.remove('active'); 
            confirmAction = null; 
        };

        window.fillPrompt = function(text) {
            const input = document.getElementById('user-input');
            input.value = text;
            input.dispatchEvent(new Event('input'));
            input.focus();
        };
        
        window.clearFileSelection = function(isManual = false) {
            if (isManual) {
                const btn = document.getElementById('clear-file-btn');
                const originalContent = btn.innerHTML;
                
                btn.innerHTML = '<div class="animate-spin w-3 h-3 border-2 border-white border-t-transparent rounded-full"></div>';
                btn.disabled = true;
                
                setTimeout(() => {
                    performClear();
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                    if(typeof lucide !== 'undefined') lucide.createIcons();
                }, 600);
            } else {
                performClear();
            }
        };

        function performClear() {
            selectedFile = null;
            document.getElementById('file-input').value = '';
            document.getElementById('file-preview-container').classList.add('hidden');
            
            const img = document.getElementById('image-preview-element');
            img.style.display = 'none'; 
            img.src = ''; 
            
            document.getElementById('file-preview-icon').classList.add('hidden');
        }
        
        window.handleFileSelect = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            selectedFile = file;
            
            const container = document.getElementById('file-preview-container');
            const imgPrev = document.getElementById('image-preview-element');
            const iconPrev = document.getElementById('file-preview-icon');
            const namePrev = document.getElementById('preview-filename');
            const sizePrev = document.getElementById('preview-filesize');
            
            namePrev.textContent = file.name;
            sizePrev.textContent = (file.size / 1024).toFixed(1) + ' KB';
            container.classList.remove('hidden');

            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    imgPrev.src = ev.target.result;
                    imgPrev.classList.remove('hidden');
                    imgPrev.style.display = 'block'; 
                    iconPrev.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                imgPrev.src = '';
                imgPrev.style.display = 'none'; 
                imgPrev.classList.add('hidden');
                iconPrev.classList.remove('hidden');
            }
        };

        window.handleEnter = function(e) {
            if(e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                document.getElementById('chat-form').dispatchEvent(new Event('submit')); 
            }
        };

        window.handleAvatarUpload = function(e) {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    botAvatarUrl = ev.target.result;
                    try { localStorage.setItem('bot_avatar', botAvatarUrl); } catch(err){}
                    loadAvatar();
                };
                reader.readAsDataURL(file);
            }
        };

        // --- Chat Rendering & Logic ---
        function scrollToBottom() {
            const container = document.getElementById('messages');
            if (container) {
                setTimeout(() => {
                    container.scrollTo({
                        top: container.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 100);
            }
        }

        function loadChatHistory() {
            try {
                // Load specific session history
                const stored = localStorage.getItem(`ciel_chat_${sessionId}`);
                if (stored) chatHistory = JSON.parse(stored);
                else chatHistory = [];
            } catch(e) { chatHistory = []; }
        }

        function saveCurrentChat() {
            try {
                localStorage.setItem(`ciel_chat_${sessionId}`, JSON.stringify(chatHistory));
            } catch(e) {}
        }

        function renderChatHistory() {
            const container = document.getElementById('messages');
            container.innerHTML = ''; 
            
            // Suggestion Chips (Only show if history is empty)
            if(chatHistory.length === 0) {
                 const chipsHtml = `
                    <div id="suggestion-chips" class="flex flex-wrap gap-2 py-2 px-2 justify-center md:justify-start ml-0 md:ml-11 chips-container">
                        <button onclick="fillPrompt('‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î Python ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö...')" class="px-4 py-2 bg-surface border border-border rounded-full text-sm text-txt-sec hover:bg-blue-600 hover:text-white hover:border-blue-500 transition shadow-sm flex items-center gap-2 flex-grow md:flex-grow-0 justify-center">
                            <span>üíª</span> ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î
                        </button>
                        <button onclick="fillPrompt('‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å...')" class="px-4 py-2 bg-surface border border-border rounded-full text-sm text-txt-sec hover:bg-pink-600 hover:text-white hover:border-pink-500 transition shadow-sm flex items-center gap-2 flex-grow md:flex-grow-0 justify-center">
                            <span>üìä</span> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                        <button onclick="fillPrompt('‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...')" class="px-4 py-2 bg-surface border border-border rounded-full text-sm text-txt-sec hover:bg-violet-600 hover:text-white hover:border-violet-500 transition shadow-sm flex items-center gap-2 flex-grow md:flex-grow-0 justify-center">
                            <span>üßÆ</span> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
                        </button>
                        <button onclick="fillPrompt('‡∏Ç‡∏≠‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö...')" class="px-4 py-2 bg-surface border border-border rounded-full text-sm text-txt-sec hover:bg-emerald-600 hover:text-white hover:border-emerald-500 transition shadow-sm flex items-center gap-2 flex-grow md:flex-grow-0 justify-center">
                            <span>üí¨</span> ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
                        </button>
                    </div>`;
                 container.insertAdjacentHTML('beforeend', chipsHtml);
            }

            chatHistory.forEach(msg => renderMessage(msg.content, msg.isUser, msg.imageUrl, msg.attachment));
            scrollToBottom();
        }

        function loadAvatar() {
            if(botAvatarUrl) {
                document.querySelectorAll('.bot-avatar').forEach(el => {
                    el.innerHTML = `<img src="${botAvatarUrl}" class="w-full h-full object-cover">`;
                });
                document.getElementById('header-avatar').innerHTML = `<img src="${botAvatarUrl}" class="w-full h-full object-cover">`;
            }
        }

        function addCopyButtons(container) {
            const pres = container.querySelectorAll('pre');
            pres.forEach(pre => {
                if (pre.querySelector('.copy-btn')) return;
                pre.style.position = 'relative';
                pre.classList.add('group');
                
                const button = document.createElement('button');
                button.className = 'copy-btn absolute top-2 right-2 text-txt-muted hover:text-white bg-surface2/50 hover:bg-surface2 rounded p-1.5 transition-all opacity-0 group-hover:opacity-100 focus:opacity-100';
                button.innerHTML = '<i data-lucide="copy" class="w-4 h-4"></i>';
                
                button.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const code = pre.querySelector('code');
                    const text = code ? code.innerText : pre.innerText;
                    
                    try {
                        // Create a temporary textarea for copying to ensure compatibility
                        const textArea = document.createElement("textarea");
                        textArea.value = text;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        
                        button.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-green-400"></i>';
                        setTimeout(() => { 
                            button.innerHTML = '<i data-lucide="copy" class="w-4 h-4"></i>'; 
                            if(typeof lucide !== 'undefined') lucide.createIcons();
                        }, 2000);
                    } catch (err) { console.error('Copy failed', err); }
                    if(typeof lucide !== 'undefined') lucide.createIcons();
                });
                pre.appendChild(button);
            });
        }

        function renderMessage(content, isUser, imageUrl, attachment) {
            const container = document.getElementById('messages');
            const wrapper = document.createElement('div');
            wrapper.className = `flex gap-3 ${isUser ? 'flex-row-reverse' : ''}`;
            
            const avatar = document.createElement('div');
            avatar.className = `w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center text-xs font-bold text-white overflow-hidden ${isUser ? 'bg-surface2 text-txt-sec' : 'bg-gradient-to-tr from-pink-500 to-violet-600 bot-avatar'}`;
            if(isUser) {
                let initial = (currentLang==='en'?'Y':'‡∏Ñ');
                if(currentUser && currentUser.name) initial = currentUser.name.charAt(0).toUpperCase();
                avatar.innerText = initial;
            } else {
                if(botAvatarUrl) avatar.innerHTML = `<img src="${botAvatarUrl}" class="w-full h-full object-cover">`;
                else avatar.innerText = '‡∏ï';
            }

            const bubble = document.createElement('div');
            bubble.className = `p-4 rounded-2xl max-w-[90%] md:max-w-[85%] shadow-md border ${isUser ? 'bg-indigo-600 text-white border-indigo-500 rounded-tr-none' : 'bg-surface text-txt-main border-border rounded-tl-none prose prose-invert max-w-none'}`;

            if(imageUrl) {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.className = "rounded-lg mb-2 max-h-48 max-w-full object-contain border border-border";
                img.onerror = function() { this.style.display = 'none'; };
                img.onload = function() { scrollToBottom(); };
                bubble.appendChild(img);
            }

            if(attachment && attachment.type === 'file') {
                const fileCard = document.createElement('div');
                fileCard.className = "flex items-center gap-3 p-3 bg-surface2/50 rounded-lg border border-border/50 mb-2 max-w-full";
                fileCard.innerHTML = `
                    <div class="w-10 h-10 bg-surface2 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i data-lucide="file-text" class="w-5 h-5 text-txt-main"></i>
                    </div>
                    <div class="flex flex-col overflow-hidden min-w-0">
                        <span class="text-sm font-medium text-txt-main truncate">${attachment.name || 'File'}</span>
                        <span class="text-xs text-txt-muted">Attached File</span>
                    </div>
                `;
                bubble.appendChild(fileCard);
                setTimeout(() => { if(typeof lucide !== 'undefined') lucide.createIcons(); }, 0);
            }

            if(content) {
                const textDiv = document.createElement('div');
                if(typeof marked !== 'undefined') {
                    try { 
                        // Fix for deprecated marked.parse in some CDN versions
                        const parseMarkdown = marked.parse ? marked.parse : marked;
                        const rawHtml = parseMarkdown(content);
                        const cleanHtml = (typeof DOMPurify !== 'undefined') ? DOMPurify.sanitize(rawHtml) : rawHtml;
                        textDiv.innerHTML = cleanHtml;
                        
                        setTimeout(() => {
                            const codeBlocks = textDiv.querySelectorAll('pre code.language-html, pre code.language-xml');
                            codeBlocks.forEach(block => {
                                const code = block.innerText;
                                const preElement = block.parentElement;
                                const previewContainer = document.createElement('div');
                                previewContainer.className = "mt-4 mb-2 rounded-xl overflow-hidden border border-slate-600 shadow-lg bg-white";
                                
                                const header = document.createElement('div');
                                header.className = "bg-slate-100 px-4 py-2 border-b border-slate-200 flex justify-between items-center";
                                header.innerHTML = `<span class="text-xs font-bold text-slate-500 flex items-center gap-1"><i data-lucide="eye" class="w-3 h-3"></i> Live Preview</span><span class="flex gap-1"><div class="w-2 h-2 rounded-full bg-red-400"></div><div class="w-2 h-2 rounded-full bg-yellow-400"></div><div class="w-2 h-2 rounded-full bg-green-400"></div></span>`;
                                
                                const iframe = document.createElement('iframe');
                                iframe.className = "w-full h-[300px] md:h-[400px] bg-white";
                                iframe.style.border = "none";
                                
                                let finalCode = code;
                                if(!code.includes('<head>') && !code.includes('cdn.tailwindcss')) {
                                    finalCode = `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><script src="https://cdn.tailwindcss.com"><\/script></head><body class="p-4 bg-gray-50 flex flex-col justify-center min-h-screen">${code}</body></html>`;
                                }
                                iframe.srcdoc = finalCode;
                                
                                previewContainer.appendChild(header);
                                previewContainer.appendChild(iframe);
                                preElement.parentNode.insertBefore(previewContainer, preElement.nextSibling);
                            });
                            addCopyButtons(textDiv);
                            if(typeof lucide !== 'undefined') lucide.createIcons();
                        }, 50);

                    } catch(e) { 
                        textDiv.innerText = content; 
                        console.error('Markdown parsing error:', e);
                    }
                } else {
                    textDiv.innerText = content;
                }
                bubble.appendChild(textDiv);
            }

            wrapper.appendChild(avatar);
            wrapper.appendChild(bubble);
            container.appendChild(wrapper);
            scrollToBottom();
            
            // Ensure icons are created for new elements
            setTimeout(() => { if(typeof lucide !== 'undefined') lucide.createIcons(); }, 10);
        }

        // UPDATED: addMessage stores state
        function addMessage(content, isUser = false, imageUrl = null, attachment = null) {
            chatHistory.push({content, isUser, imageUrl, attachment});
            saveCurrentChat();
            
            if(isUser) {
                const chips = document.getElementById('suggestion-chips');
                if(chips) chips.classList.add('hidden');
                
                // Update session title if it's "New Chat" and this is first user message
                const session = sessions.find(s => s.id === sessionId);
                if (session && session.title === 'New Chat') {
                    // Truncate to ~20 chars
                    session.title = content.substring(0, 20) + (content.length > 20 ? '...' : '');
                    localStorage.setItem('ciel_sessions', JSON.stringify(sessions));
                    renderSessionList();
                }
            }
            renderMessage(content, isUser, imageUrl, attachment);
        }

        // --- Initialization ---
        window.addEventListener('DOMContentLoaded', () => {
            applyTheme(currentTheme); 
            const loader = document.getElementById('page-loader');
            if(loader) {
                setTimeout(() => {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.style.display = 'none', 300);
                }, 300);
            }
            if(typeof lucide !== 'undefined') lucide.createIcons();
            
            updateContent();
            updateAuthUI();
            loadAvatar();
            
            // LOAD SESSIONS FIRST
            loadSessions();
            renderSessionList();
            
            // LOAD CURRENT SESSION HISTORY
            loadChatHistory();
            
            navigateTo('home');

            const userInput = document.getElementById('user-input');
            if(userInput) {
                userInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            }

            const confirmYesBtn = document.getElementById('confirm-yes-btn');
            if(confirmYesBtn) {
                confirmYesBtn.onclick = () => {
                    if(confirmAction) confirmAction();
                    closeConfirmModal();
                };
            }

            document.getElementById('chat-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = document.getElementById('user-input');
                const text = input.value.trim();
                
                const fileToSend = selectedFile; 
                
                if(!text && !fileToSend) return;

                let previewUrl = null;
                let attachmentData = null;

                if(fileToSend) {
                    if(fileToSend.type.startsWith('image/')) {
                        const prevImg = document.getElementById('image-preview-element');
                        if(prevImg.src && prevImg.src.startsWith('data:')) {
                            previewUrl = prevImg.src;
                        }
                    } else {
                        attachmentData = { type: 'file', name: fileToSend.name };
                    }
                }
                
                addMessage(text, true, previewUrl, attachmentData);
                
                input.value = '';
                input.style.height = '48px';
                clearFileSelection(); 
                input.focus();
                
                const sendBtn = document.getElementById('send-btn');
                const originalBtnContent = sendBtn.innerHTML;
                sendBtn.innerHTML = '<div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div>';
                sendBtn.disabled = true;

                const loadingId = 'loading-' + Date.now();
                const loadingHtml = `<div id="${loadingId}" class="flex gap-3"><div class="bot-avatar w-8 h-8 rounded-full bg-gradient-to-tr from-pink-500 to-violet-600 flex-shrink-0 flex items-center justify-center text-xs font-bold text-white">‡∏ï</div><div class="bg-surface p-4 rounded-2xl rounded-tl-none border border-border flex gap-2 items-center"><div class="typing-dot w-2 h-2 bg-pink-500 rounded-full"></div><div class="typing-dot w-2 h-2 bg-purple-500 rounded-full"></div><div class="typing-dot w-2 h-2 bg-indigo-500 rounded-full"></div></div></div>`;
                document.getElementById('messages').insertAdjacentHTML('beforeend', loadingHtml);
                scrollToBottom();

                try {
                    const formData = new FormData();
                    formData.append('chatInput', text);
                    formData.append('sessionId', sessionId);
                    
                    if(fileToSend) {
                        formData.append('file', fileToSend);
                    }
                    
                    // --- DYNAMIC URL SELECTION ---
                    const TARGET_URL = API_ENDPOINTS[currentAgent] || API_ENDPOINTS['ciel'];
                    // -----------------------------
                    
                    const response = await fetch(TARGET_URL, { method: 'POST', body: formData });
                    
                    if(!response.ok) throw new Error('Network response was not ok: ' + response.statusText);
                    
                    const data = await response.json();
                    let botResp = "Received empty response";
                    if(Array.isArray(data) && data.length > 0) botResp = data[0].output || data[0].text || JSON.stringify(data[0]);
                    else if(typeof data === 'object') botResp = data.output || data.text || JSON.stringify(data);
                    else botResp = String(data);

                    addMessage(botResp);
                } catch(err) {
                    console.warn(err);
                    setTimeout(() => {
                        const errMsg = currentLang === 'en' 
                            ? "ü§ñ [Connection Error] I couldn't reach the n8n server. Please check if your n8n workflow is active and CORS is enabled." 
                            : "ü§ñ [‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á] ‡∏ú‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå n8n ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Workflow ‡πÉ‡∏ô n8n ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î CORS ‡πÄ‡∏õ‡πá‡∏ô '*' ‡πÅ‡∏•‡πâ‡∏ß)";
                        addMessage(errMsg);
                    }, 1000);
                } finally {
                    const loader = document.getElementById(loadingId);
                    if(loader) loader.remove();
                    sendBtn.innerHTML = originalBtnContent;
                    sendBtn.disabled = false;
                    if(typeof lucide !== 'undefined') lucide.createIcons();
                }
            });
        });
    </script>
</body>
</html>
